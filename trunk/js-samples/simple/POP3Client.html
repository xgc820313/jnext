<HTML>
<BODY>
<script src="jnext/jnext.js"></script>
<script src="jnext/sockets.js"></script>

<script>
//////////////////////////////////////////////////////////////////////////
// Simple POP3 email reader using JNEXT
// v1.0 26-Sept-2007 Amnon David

function updateStatus( strMsg )
{
    document.getElementById( "id_Status" ).innerHTML = strMsg;
}

function readPOP3()
{
    arColors = new Array(); arColors[ 0 ] = "f0f0f0"; arColors[ 1 ] = "e0e0e0";
	mySocket = new AsyncLineSocket();
    mySocket.m_strState = "Idle";
    mySocket.m_strList = "";
    mySocket.m_nFlip = 1;

    mySocket.m_strUser  = document.getElementById( "id_User" ).value;
    mySocket.m_strPass  = document.getElementById( "id_Pass" ).value;
    var strServer       = document.getElementById( "id_POP3" ).value;
    
	mySocket.onConnectError = function()
    {
        updateStatus( "Error" );
        alert( "Error while connecting to " + strServer );
        this.close();
        this.m_strState = "Idle";
    }
    
    mySocket.onConnected = function()
    {
        this.m_strState = "Connected";
        updateStatus( this.m_strState );
    }
    
	mySocket.onLine = function( strLine )
    {            
        updateStatus( this.m_strState );
        
        var strStatus = strLine.substr( 0, 4 );
        if ( strStatus == "-ERR" )
        {
            alert( strLine + "\nError during POP3 conversation - aborting" );
            this.close();
            this.m_strState = "Idle";
            return;
        }
        
        switch ( this.m_strState )
        {
            case "Connected":
            {
                this.m_strState = "SentUser";
                this.sendLine( "user " + this.m_strUser  );
                break;                
            }
            
            case "SentUser":
            {
                this.m_strState = "SentPass";
                this.sendLine( "pass " + this.m_strPass  );
                break;                
            }
            
            case "SentPass":
            {
                this.m_strState = "SentStat";
                this.sendLine( "stat"  );
                break;                
            }
            
            case "SentStat":
            {
                this.m_nIndex = 1;
                this.m_nTotal = parseInt( strLine.split( " " )[ 1 ] );
                if ( this.m_nTotal > 0 )
                {
                    this.m_strState = "Reading";
                    this.sendLine( "top 1 1" );
                }
                break;
            }
            
            case "Reading":
            {
                if ( strLine == "." )
                {
                    this.m_nIndex++;
                    if ( this.m_nIndex <= this.m_nTotal )
                    {
                        this.sendLine( "top " + this.m_nIndex + " 1" );
                    }
                    else
                    {
                        this.m_strList += "</table>";
                        document.getElementById( "id_List" ).innerHTML = this.m_strList;
                        this.sendLine( "quit" );
                        this.close();
                        this.m_strState = "Idle";
                        updateStatus( "Done" );
                        return;
                    }
                }
                else                
                if ( strLine.substr( 0, 8 ) == "Subject:" )
                {
                    if ( this.m_nIndex == 1 )
                    {
                        this.m_strList = "<table>";
                    }
                    var strSubject = strLine.substr( 9 );
                    this.m_nFlip = 1 - this.m_nFlip;
                    this.m_strList += "<tr bgColor='" + arColors[ this.m_nFlip ] + "'><td>" + strSubject + "</td></tr>"
                }
                break;                
            }
        }
    }
    
	mySocket.onClose = function() { this.m_strState = "Idle"; this.close(); }

    mySocket.m_strState = "Connecting";
    document.getElementById( "id_List" ).innerHTML = "";
	mySocket.connect( strServer, 110 );
}


</script>
<h3>JNEXT POP3 reader test</h3>
<table bgcolor="beige">
    <tr><td>POP3 Server</td><td><input type="text" value="pop3.bezeqint.net" id="id_POP3"></input></td></tr>
    <tr><td>Username</td><td><input type="text" value="amnon_david" id="id_User"></input></td></tr>
    <tr><td>Password</td><td><input type="password" value="surb0801" id="id_Pass"></input></td></tr>
    <tr><td><input type=button value="Connect" onclick='readPOP3()'></td><td id="id_Status"></td></tr>
</table>

<hr/>
<div id="id_List"></div>
</BODY>
</HTML>
